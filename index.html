<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>DRONA - Your AI Tutor</title>
    <link href="https://fonts.googleapis.com/css2?family=Crimson+Pro:wght@400;600;700&family=DM+Sans:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #1a4d2e;
            --secondary: #4f772d;
            --accent: #f4a259;
            --light: #faf3e0;
            --white: #ffffff;
            --text-dark: #2d3748;
            --text-light: #718096;
            --shadow: rgba(26, 77, 46, 0.1);
            --border: rgba(79, 119, 45, 0.2);
        }

        body {
            font-family: 'DM Sans', sans-serif;
            background: linear-gradient(135deg, #faf3e0 0%, #f0e6d2 100%);
            color: var(--text-dark);
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* Decorative Background Pattern */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: 
                radial-gradient(circle at 20% 30%, rgba(79, 119, 45, 0.03) 0%, transparent 50%),
                radial-gradient(circle at 80% 70%, rgba(244, 162, 89, 0.03) 0%, transparent 50%);
            pointer-events: none;
            z-index: 0;
        }

        .container {
            max-width: 100%;
            margin: 0 auto;
            position: relative;
            z-index: 1;
        }

        /* Login Screen */
        .login-screen {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 2rem;
            animation: fadeIn 0.6s ease-out;
        }

        .logo {
            font-family: 'Crimson Pro', serif;
            font-size: 4rem;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 0.5rem;
            letter-spacing: 0.05em;
            text-shadow: 2px 2px 0 var(--accent);
        }

        .tagline {
            font-size: 1.1rem;
            color: var(--text-light);
            margin-bottom: 3rem;
            font-style: italic;
        }

        .user-selection {
            display: flex;
            gap: 2rem;
            flex-wrap: wrap;
            justify-content: center;
            margin-bottom: 2rem;
        }

        .user-card {
            background: var(--white);
            border-radius: 20px;
            padding: 2rem;
            width: 260px;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 3px solid transparent;
            box-shadow: 0 10px 30px var(--shadow);
            position: relative;
            overflow: hidden;
        }

        .user-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 5px;
            background: linear-gradient(90deg, var(--primary), var(--secondary));
            transform: scaleX(0);
            transition: transform 0.3s ease;
        }

        .user-card:hover {
            transform: translateY(-5px);
            border-color: var(--secondary);
            box-shadow: 0 15px 40px rgba(79, 119, 45, 0.2);
        }

        .user-card:hover::before {
            transform: scaleX(1);
        }

        .user-icon {
            font-size: 4rem;
            margin-bottom: 1rem;
        }

        .user-name {
            font-family: 'Crimson Pro', serif;
            font-size: 1.8rem;
            font-weight: 600;
            color: var(--primary);
            margin-bottom: 0.5rem;
        }

        .user-role {
            color: var(--text-light);
            font-size: 0.95rem;
        }

        /* Main App */
        .app-container {
            display: none;
            flex-direction: column;
            height: 100vh;
            animation: slideIn 0.5s ease-out;
        }

        .app-container.active {
            display: flex;
        }

        /* Header */
        .header {
            background: var(--white);
            padding: 1rem 1.5rem;
            box-shadow: 0 2px 10px var(--shadow);
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: relative;
        }

        .header-title {
            font-family: 'Crimson Pro', serif;
            font-size: 1.8rem;
            font-weight: 700;
            color: var(--primary);
        }

        .user-badge {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            background: var(--light);
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-size: 0.9rem;
        }

        .logout-btn {
            background: var(--secondary);
            color: var(--white);
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .logout-btn:hover {
            background: var(--primary);
            transform: scale(1.05);
        }

        /* Chat Area */
        .chat-container {
            flex: 1;
            overflow-y: auto;
            padding: 2rem 1.5rem;
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }

        .message {
            display: flex;
            gap: 1rem;
            animation: messageSlide 0.4s ease-out;
        }

        .message.user {
            flex-direction: row-reverse;
        }

        .message-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            flex-shrink: 0;
        }

        .message.assistant .message-avatar {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: var(--white);
        }

        .message.user .message-avatar {
            background: var(--accent);
            color: var(--white);
        }

        .message-content {
            background: var(--white);
            padding: 1rem 1.5rem;
            border-radius: 20px;
            max-width: 75%;
            box-shadow: 0 2px 10px var(--shadow);
            line-height: 1.6;
        }

        .message.user .message-content {
            background: var(--secondary);
            color: var(--white);
        }

        /* Concept Tags */
        .concept-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-top: 0.75rem;
        }

        .concept-tag {
            background: var(--light);
            color: var(--secondary);
            padding: 0.3rem 0.8rem;
            border-radius: 15px;
            font-size: 0.8rem;
            font-weight: 500;
            border: 1px solid var(--border);
        }

        /* Connections Panel */
        .connections-indicator {
            background: linear-gradient(135deg, rgba(79, 119, 45, 0.1), rgba(244, 162, 89, 0.1));
            padding: 1rem;
            border-radius: 15px;
            margin-top: 0.75rem;
            border-left: 4px solid var(--accent);
            font-size: 0.9rem;
        }

        .connection-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-top: 0.5rem;
            color: var(--text-dark);
        }

        /* Input Area */
        .input-container {
            background: var(--white);
            padding: 1.5rem;
            box-shadow: 0 -2px 10px var(--shadow);
        }

        .input-wrapper {
            display: flex;
            gap: 1rem;
            align-items: center;
        }

        .input-field {
            flex: 1;
            border: 2px solid var(--border);
            padding: 1rem 1.5rem;
            border-radius: 25px;
            font-size: 1rem;
            font-family: 'DM Sans', sans-serif;
            transition: all 0.3s ease;
            background: var(--light);
        }

        .input-field:focus {
            outline: none;
            border-color: var(--secondary);
            background: var(--white);
        }

        .voice-btn, .send-btn {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.3rem;
            transition: all 0.3s ease;
        }

        .voice-btn {
            background: var(--accent);
            color: var(--white);
        }

        .voice-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 5px 15px rgba(244, 162, 89, 0.4);
        }

        .voice-btn.listening {
            animation: pulse 1.5s infinite;
            background: #e63946;
        }

        .send-btn {
            background: var(--secondary);
            color: var(--white);
        }

        .send-btn:hover {
            transform: scale(1.1);
            background: var(--primary);
        }

        .send-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Dashboard */
        .dashboard {
            position: fixed;
            top: 0;
            right: -100%;
            width: 90%;
            max-width: 400px;
            height: 100vh;
            background: var(--white);
            box-shadow: -5px 0 20px var(--shadow);
            padding: 2rem;
            overflow-y: auto;
            transition: right 0.4s ease;
            z-index: 1000;
        }

        .dashboard.active {
            right: 0;
        }

        .dashboard-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
        }

        .dashboard-title {
            font-family: 'Crimson Pro', serif;
            font-size: 1.8rem;
            color: var(--primary);
        }

        .close-dashboard {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--text-light);
        }

        .stat-card {
            background: linear-gradient(135deg, var(--light), #fff);
            padding: 1.5rem;
            border-radius: 15px;
            margin-bottom: 1rem;
            border-left: 4px solid var(--secondary);
        }

        .stat-label {
            color: var(--text-light);
            font-size: 0.9rem;
            margin-bottom: 0.5rem;
        }

        .stat-value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--primary);
            font-family: 'Crimson Pro', serif;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: var(--light);
            border-radius: 10px;
            overflow: hidden;
            margin-top: 0.5rem;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--secondary), var(--accent));
            border-radius: 10px;
            transition: width 0.5s ease;
        }

        .topics-list {
            margin-top: 2rem;
        }

        .topic-item {
            background: var(--white);
            padding: 1rem;
            border-radius: 10px;
            margin-bottom: 0.75rem;
            border: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .topic-name {
            font-weight: 500;
            color: var(--primary);
        }

        .topic-count {
            background: var(--secondary);
            color: var(--white);
            padding: 0.25rem 0.75rem;
            border-radius: 15px;
            font-size: 0.85rem;
        }

        /* Floating Action Button */
        .fab {
            position: fixed;
            bottom: 100px;
            right: 20px;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: var(--primary);
            color: var(--white);
            border: none;
            cursor: pointer;
            box-shadow: 0 5px 20px var(--shadow);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            transition: all 0.3s ease;
            z-index: 999;
        }

        .fab:hover {
            transform: scale(1.1);
            box-shadow: 0 8px 30px rgba(26, 77, 46, 0.3);
        }

        /* Animations */
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes slideIn {
            from { 
                opacity: 0;
                transform: translateY(20px);
            }
            to { 
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes messageSlide {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes pulse {
            0%, 100% {
                transform: scale(1);
                opacity: 1;
            }
            50% {
                transform: scale(1.05);
                opacity: 0.8;
            }
        }

        /* Typing Indicator */
        .typing-indicator {
            display: flex;
            gap: 0.3rem;
            padding: 1rem;
        }

        .typing-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--secondary);
            animation: typingDot 1.4s infinite;
        }

        .typing-dot:nth-child(2) {
            animation-delay: 0.2s;
        }

        .typing-dot:nth-child(3) {
            animation-delay: 0.4s;
        }

        @keyframes typingDot {
            0%, 60%, 100% {
                transform: translateY(0);
                opacity: 0.7;
            }
            30% {
                transform: translateY(-10px);
                opacity: 1;
            }
        }

        /* Responsive */
        @media (max-width: 768px) {
            .logo {
                font-size: 3rem;
            }

            .user-card {
                width: 100%;
                max-width: 300px;
            }

            .message-content {
                max-width: 85%;
            }

            .dashboard {
                width: 100%;
                max-width: 100%;
            }
        }

        /* Loading State */
        .loading {
            text-align: center;
            padding: 2rem;
            color: var(--text-light);
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid var(--light);
            border-top-color: var(--secondary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 1rem auto;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <!-- Login Screen -->
    <div class="login-screen" id="loginScreen">
        <div class="logo">DRONA</div>
        <div class="tagline">Your Personal AI Tutor</div>
        
        <div class="user-selection">
            <div class="user-card" onclick="selectUser('parent')">
                <div class="user-icon">üë®‚Äçüíº</div>
                <div class="user-name">Parent</div>
                <div class="user-role">Advanced Learning Mode</div>
            </div>
            
            <div class="user-card" onclick="selectUser('child')">
                <div class="user-icon">üë¶</div>
                <div class="user-name">Child</div>
                <div class="user-role">Fun & Simple Mode</div>
            </div>
        </div>
    </div>

    <!-- Main App -->
    <div class="app-container" id="appContainer">
        <div class="header">
            <div class="header-title">DRONA</div>
            <div style="display: flex; gap: 1rem; align-items: center;">
                <div class="user-badge" id="userBadge"></div>
                <button class="logout-btn" onclick="logout()">Logout</button>
            </div>
        </div>

        <div class="chat-container" id="chatContainer">
            <!-- Welcome message will be inserted here -->
        </div>

        <div class="input-container">
            <div class="input-wrapper">
                <button class="voice-btn" id="voiceBtn" onclick="toggleVoice()">üé§</button>
                <input 
                    type="text" 
                    class="input-field" 
                    id="messageInput" 
                    placeholder="Ask me anything..."
                    onkeypress="handleKeyPress(event)"
                />
                <button class="send-btn" id="sendBtn" onclick="sendMessage()">üì§</button>
            </div>
        </div>
    </div>

    <!-- Dashboard -->
    <div class="dashboard" id="dashboard">
        <div class="dashboard-header">
            <div class="dashboard-title">Progress Dashboard</div>
            <button class="close-dashboard" onclick="toggleDashboard()">‚úï</button>
        </div>

        <div class="stat-card">
            <div class="stat-label">Total Conversations</div>
            <div class="stat-value" id="totalConversations">0</div>
        </div>

        <div class="stat-card">
            <div class="stat-label">Topics Explored</div>
            <div class="stat-value" id="topicsExplored">0</div>
        </div>

        <div class="stat-card">
            <div class="stat-label">Connections Made</div>
            <div class="stat-value" id="connectionsMade">0</div>
            <div class="progress-bar">
                <div class="progress-fill" id="connectionsProgress" style="width: 0%"></div>
            </div>
        </div>

        <div class="topics-list">
            <h3 style="font-family: 'Crimson Pro', serif; color: var(--primary); margin-bottom: 1rem;">Recent Topics</h3>
            <div id="topicsList"></div>
        </div>

        <div style="margin-top: 2rem; padding-top: 2rem; border-top: 1px solid var(--border);">
            <div id="parentInsights"></div>
        </div>
    </div>

    <!-- Floating Action Button -->
    <button class="fab" id="fab" onclick="toggleDashboard()" style="display: none;">üìä</button>

    <script>
        // Global State
        let currentUser = null;
        let conversationHistory = [];
        let isListening = false;
        let recognition = null;
        let synthesis = window.speechSynthesis;
        let userStats = {
            parent: {
                totalConversations: 0,
                topicsExplored: {},
                connections: [],
                learningPath: []
            },
            child: {
                totalConversations: 0,
                topicsExplored: {},
                connections: [],
                learningPath: []
            }
        };

        // Initialize Speech Recognition
        if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            recognition = new SpeechRecognition();
            recognition.continuous = false;
            recognition.interimResults = false;
            recognition.lang = 'en-US';

            recognition.onresult = (event) => {
                const transcript = event.results[0][0].transcript;
                document.getElementById('messageInput').value = transcript;
                sendMessage();
            };

            recognition.onend = () => {
                isListening = false;
                document.getElementById('voiceBtn').classList.remove('listening');
            };
        }

        // Load saved stats from localStorage
        function loadStats() {
            const savedStats = localStorage.getItem('dronaStats');
            if (savedStats) {
                userStats = JSON.parse(savedStats);
            }
        }

        // Save stats to localStorage
        function saveStats() {
            localStorage.setItem('dronaStats', JSON.stringify(userStats));
        }

        // User Selection
        function selectUser(user) {
            currentUser = user;
            loadStats();
            
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('appContainer').classList.add('active');
            document.getElementById('fab').style.display = 'flex';
            
            const userIcon = user === 'parent' ? 'üë®‚Äçüíº' : 'üë¶';
            const userName = user === 'parent' ? 'Parent Mode' : 'Child Mode';
            document.getElementById('userBadge').innerHTML = `<span>${userIcon}</span><span>${userName}</span>`;
            
            // Show welcome message
            showWelcomeMessage();
            updateDashboard();
        }

        function logout() {
            saveStats();
            currentUser = null;
            conversationHistory = [];
            document.getElementById('appContainer').classList.remove('active');
            document.getElementById('loginScreen').style.display = 'flex';
            document.getElementById('fab').style.display = 'none';
            document.getElementById('chatContainer').innerHTML = '';
        }

        function showWelcomeMessage() {
            const welcomeMessages = {
                parent: "Hello! I'm DRONA, your AI tutor. I'm here to help you master topics like macroeconomics, payment systems, and more. I'll help you discover connections between concepts and build a personalized learning path. What would you like to explore today?",
                child: "Hi there! I'm DRONA, and I'm so excited to learn with you! We can explore anything you're curious about. I'll make learning fun and help you discover how different things connect. What do you want to learn about today?"
            };

            addMessage('assistant', welcomeMessages[currentUser]);
        }

        function addMessage(sender, content, concepts = [], connections = []) {
            const chatContainer = document.getElementById('chatContainer');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${sender}`;
            
            const icon = sender === 'assistant' ? 'üéì' : (currentUser === 'parent' ? 'üë®‚Äçüíº' : 'üë¶');
            
            let messageHTML = `
                <div class="message-avatar">${icon}</div>
                <div class="message-content">
                    ${content}
            `;

            if (concepts && concepts.length > 0) {
                messageHTML += `
                    <div class="concept-tags">
                        ${concepts.map(c => `<span class="concept-tag">${c}</span>`).join('')}
                    </div>
                `;
            }

            if (connections && connections.length > 0) {
                messageHTML += `
                    <div class="connections-indicator">
                        <strong>üîó Connections Found:</strong>
                        ${connections.map(c => `<div class="connection-item">‚Üí ${c}</div>`).join('')}
                    </div>
                `;
            }

            messageHTML += `</div>`;
            messageDiv.innerHTML = messageHTML;
            
            chatContainer.appendChild(messageDiv);
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        function showTypingIndicator() {
            const chatContainer = document.getElementById('chatContainer');
            const typingDiv = document.createElement('div');
            typingDiv.className = 'message assistant';
            typingDiv.id = 'typingIndicator';
            typingDiv.innerHTML = `
                <div class="message-avatar">üéì</div>
                <div class="message-content">
                    <div class="typing-indicator">
                        <div class="typing-dot"></div>
                        <div class="typing-dot"></div>
                        <div class="typing-dot"></div>
                    </div>
                </div>
            `;
            chatContainer.appendChild(typingDiv);
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        function removeTypingIndicator() {
            const indicator = document.getElementById('typingIndicator');
            if (indicator) {
                indicator.remove();
            }
        }

        async function sendMessage() {
            const input = document.getElementById('messageInput');
            const message = input.value.trim();
            
            if (!message) return;
            
            addMessage('user', message);
            input.value = '';
            
            conversationHistory.push({
                role: 'user',
                content: message
            });

            showTypingIndicator();

            try {
                const response = await getAIResponse(message);
                removeTypingIndicator();
                
                // Extract concepts and connections
                const concepts = extractConcepts(message, response);
                const connections = findConnections(concepts);
                
                addMessage('assistant', response, concepts, connections);
                
                // Update stats
                updateUserStats(concepts, connections);
                updateDashboard();
                
                // Text-to-speech for responses (especially useful for child mode)
                if (currentUser === 'child') {
                    speakResponse(response);
                }
                
                conversationHistory.push({
                    role: 'assistant',
                    content: response
                });

            } catch (error) {
                removeTypingIndicator();
                addMessage('assistant', "I'm sorry, I encountered an error. Please try again.");
                console.error('Error:', error);
            }
        }

        async function getAIResponse(message) {
            const systemPrompt = currentUser === 'parent' 
                ? `You are DRONA, an expert AI tutor for an adult professional learning about macroeconomics, payment systems, banking, and related topics. Provide detailed, sophisticated explanations with real-world examples. Make connections between concepts. Be professional but approachable. Keep responses focused and practical.`
                : `You are DRONA, a friendly and patient AI tutor for a 5-year-old child. Use simple words, fun examples, and encourage curiosity. Make learning feel like an exciting adventure. Use analogies a young child can understand. Keep explanations short and engaging. Celebrate their questions!`;

            const messages = [
                { role: 'user', content: systemPrompt },
                ...conversationHistory.slice(-6), // Keep last 3 exchanges for context
                { role: 'user', content: message }
            ];

            try {
                const response = await fetch('https://api.anthropic.com/v1/messages', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'x-api-key': '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',
                        'anthropic-version': '2023-06-01'
                    },
                    body: JSON.stringify({
                        model: 'claude-sonnet-4-20250514',
                        max_tokens: 1000,
                        messages: messages
                    })
                });

                const data = await response.json();
                return data.content[0].text;
            } catch (error) {
                console.error('API Error:', error);
                return "I'm having trouble connecting right now. Please check your internet connection and try again.";
            }
        }

        function extractConcepts(userMessage, aiResponse) {
            const concepts = new Set();
            const keywords = [
                'macroeconomics', 'inflation', 'gdp', 'monetary policy', 'fiscal policy',
                'payment systems', 'banking', 'interest rates', 'central bank', 'supply', 'demand',
                'economics', 'finance', 'money', 'trade', 'market', 'investment',
                'numbers', 'counting', 'shapes', 'colors', 'animals', 'science', 'nature'
            ];

            const text = (userMessage + ' ' + aiResponse).toLowerCase();
            keywords.forEach(keyword => {
                if (text.includes(keyword)) {
                    concepts.add(keyword.charAt(0).toUpperCase() + keyword.slice(1));
                }
            });

            return Array.from(concepts);
        }

        function findConnections(newConcepts) {
            const connections = [];
            const allTopics = Object.keys(userStats[currentUser].topicsExplored);
            
            const relatedConcepts = {
                'inflation': ['monetary policy', 'interest rates', 'gdp'],
                'gdp': ['economics', 'trade', 'inflation'],
                'payment systems': ['banking', 'finance', 'money'],
                'monetary policy': ['central bank', 'interest rates', 'inflation'],
                'banking': ['payment systems', 'finance', 'investment']
            };

            newConcepts.forEach(concept => {
                const conceptLower = concept.toLowerCase();
                if (relatedConcepts[conceptLower]) {
                    relatedConcepts[conceptLower].forEach(related => {
                        const relatedCap = related.charAt(0).toUpperCase() + related.slice(1);
                        if (allTopics.includes(relatedCap)) {
                            connections.push(`This relates to ${relatedCap} that you learned earlier!`);
                        }
                    });
                }
            });

            return connections;
        }

        function updateUserStats(concepts, connections) {
            userStats[currentUser].totalConversations++;
            
            concepts.forEach(concept => {
                userStats[currentUser].topicsExplored[concept] = 
                    (userStats[currentUser].topicsExplored[concept] || 0) + 1;
            });

            if (connections.length > 0) {
                userStats[currentUser].connections.push(...connections);
            }

            saveStats();
        }

        function updateDashboard() {
            const stats = userStats[currentUser];
            
            document.getElementById('totalConversations').textContent = stats.totalConversations;
            document.getElementById('topicsExplored').textContent = Object.keys(stats.topicsExplored).length;
            document.getElementById('connectionsMade').textContent = stats.connections.length;
            
            const progress = Math.min((stats.connections.length / 10) * 100, 100);
            document.getElementById('connectionsProgress').style.width = progress + '%';
            
            // Update topics list
            const topicsList = document.getElementById('topicsList');
            topicsList.innerHTML = '';
            
            const topicsArray = Object.entries(stats.topicsExplored)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 10);
            
            topicsArray.forEach(([topic, count]) => {
                const topicDiv = document.createElement('div');
                topicDiv.className = 'topic-item';
                topicDiv.innerHTML = `
                    <span class="topic-name">${topic}</span>
                    <span class="topic-count">${count}</span>
                `;
                topicsList.appendChild(topicDiv);
            });

            // Parent insights if viewing child's progress
            if (currentUser === 'child') {
                const insights = document.getElementById('parentInsights');
                insights.innerHTML = `
                    <h3 style="font-family: 'Crimson Pro', serif; color: var(--primary); margin-bottom: 1rem;">Learning Insights</h3>
                    <div class="stat-card">
                        <p style="color: var(--text-dark); line-height: 1.6;">
                            Your child has explored ${Object.keys(stats.topicsExplored).length} different topics 
                            and made ${stats.connections.length} connections between concepts! 
                            ${stats.connections.length > 5 ? "They're developing excellent critical thinking skills! üåü" : "Encourage them to ask more questions to discover connections!"}
                        </p>
                    </div>
                `;
            } else {
                document.getElementById('parentInsights').innerHTML = '';
            }
        }

        function toggleDashboard() {
            document.getElementById('dashboard').classList.toggle('active');
        }

        function toggleVoice() {
            if (!recognition) {
                alert('Voice recognition is not supported in your browser. Please use Chrome or Safari.');
                return;
            }

            if (isListening) {
                recognition.stop();
                isListening = false;
                document.getElementById('voiceBtn').classList.remove('listening');
            } else {
                recognition.start();
                isListening = true;
                document.getElementById('voiceBtn').classList.add('listening');
            }
        }

        function speakResponse(text) {
            if (synthesis.speaking) {
                synthesis.cancel();
            }

            const utterance = new SpeechSynthesisUtterance(text);
            utterance.rate = 0.9;
            utterance.pitch = 1.1;
            utterance.volume = 1;
            
            synthesis.speak(utterance);
        }

        function handleKeyPress(event) {
            if (event.key === 'Enter') {
                sendMessage();
            }
        }

        // Initialize on load
        loadStats();
    </script>
</body>
</html>
